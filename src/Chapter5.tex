\section{Numerical features and tags. The table view.}

Mastodon is a tracking and lineaging tool.
Its output is a collection of tracks, and the analysis of these tracks to yield statistics on \eg velocity, displacement \etc is carried out in another software package such as MATLAB or Python.
Nonetheless you will find in Mastodon tools to compute \textit{numerical features} on data item. 
Numerical features are numbers that can be calculated on spots, links and tracks of the data. 
For instance there are feature for the number of links that touch a spot, or the displacement of a link or the number of spots in a track.
You can find them within Mastodon because it is convenient, but also because they are very useful for the interactive exploration of your data. 
Coupled with feature-based coloring, the display and sorting of values in the table view and the selection creator tool, they can considerably accelerate and facilitate making sense of the data.

Numerical features are numbers that classically relate to a physical quantity.
When we need to \textit{categorize} items, we rely on \textit{tags}.
We describe them just below. 
This chapter will also show you how to compute numerical features and create a coloring view from the feature values and  tags.
Doing so, we will introduce the third kind of data view in Mastodon: the data tables.


\subsection{Tags and tag-sets.}

As we said above, every-time you need to categorize certain data items, or need to visualize categories, you should rely on tags.
Let's suppose that you are investigating the trajectories of cells in a developing embryo from an early stage to a stage where the embryo is polarized.
Some cells will migrate to the anterior part, some others to the posterior part, \etc. 
You might want to tag cell tracks with the \texttt{Anterior} or \texttt{Posterior} tag, to investigate where does these cell come from in the early embryo.
Or let's say that you are curating the results of the automated tracking on a large images. 
The tracking results might have some inaccuracies, and you want to correct them for important tracks.
Because there is a lot of tracks, you share the workload with some colleagues. 
You work asynchronously with them, editing the Mastodon file one after another. 
Doing so, you can use tags in Mastodon to mark some tracks as reviewed by you.
Your colleagues will use a tag for themselves, to ensure that no two scientists are reviewing the same track twice.
All the cells that are not tagged in this categorisation are still waiting to be reviewed. 

In Mastodon, a categorization corresponds to a \textbf{tag-set}.
A tag-set defines a property that can have a reasonable number of discrete values, or \textbf{tags}.
In the first of the two examples above, \texttt{Location} would be a tag-set to specify the location of cells.
\texttt{Anterior} and \texttt{Posterior} would be two tags belonging to the \texttt{Location} tag-set.
In the second example, \texttt{Reviewed by} would be a tag-set, and \texttt{Mette}, \texttt{Pavel}, \texttt{Tobias} and \texttt{Jean-Yves} would be 4 tags of this tag-set.

You can assign tags to spots and links.
To assign a tag to a whole track, you have to assign this tag to all the spots and links of this track.
One data item (a spot or a ling) can have 1 or 0 tags per existing tag-set.
But they can be categorized by as many tag-sets as there is.
For instance, a spot can have the tag \texttt{Anterior} in the \texttt{Location} tag-set, and the tag \texttt{Pavel} in the \texttt{Reviewed by} tag-set. 
Or it can be not tagged in the \texttt{Reviewed by} tag-set.
But it cannot have both the tag \texttt{Mette} and the tag \texttt{Tobias} because they belong to the same tag-set.
Each tag-set works independently, and clearing a tag-set does not affect the others even for one data item.
Now that we set things straight, let's see how to create tag-sets.
We will base the demonstration in this chapter on the data we generated in the tutorial chapter~\ref{Getting_started}.


\subsubsection{Creating tag-sets.}

On the main window (see Figure~\ref{fig:MastodonMainWindow} page~\pageref{fig:MastodonMainWindow}), there is a button \texttt{configure tags}. 
Pressing it opens the tag-set dialog. 
Right now, it appears as an empty table made of two columns. 
This is where you enter tag-sets and tags.

Press the \smallimg{add.png} button on the left column to create a new tag-set. 
A default name is shown for the tag-set, that you can edit.
You can also directly press the  \keys{\return} key to immediately start editing the new tag-set.
Let's say we want to create the location tag we talked about before.
Type \texttt{Location} in the text field. 
An empty line followed by a \smallimg{add.png} button should appear on the right column.
This is where you will enter the tags of this tag-set.
Click on this button, or press the \keys{\tab} key followed by the \keys{\return} key to create a new tag.
For instance, the \texttt{Anterior} tag.
Note that a tag is only made of a label (the text) and a color.
The color will be used in Mastodon views.
Create a second tag for the same tag-set called \texttt{Posterior}.
Pick the color as you like. 
Now try to create another tag-set called \texttt{Reviewed by} and create some tags in this tag-set. 
The tag-set dialog is normally fully navigable with the \keys{\tab}, \keys{\arrowkeyup} and \keys{\arrowkeydown} keys, so that you can enter tags quickly if you have a lot of them.
You can create new tag-set or new tags with the \keys{\return} key, and delete them either with the \keys{\del} key or by pressing the \smallimg{delete.png} button.

When you are finished, press the \menu{OK} button.



\subsubsection{Assigning tags to data items.}

Tags are set via the selection tool, presented above (chapter~\ref{Selection_tool} page~\pageref{Selection_tool}).
Once you have some spots and links in the selection, you can assign a tag to it via the \menu{Edit > Tags > The tag set name > The tag label} menu.
The menu content will be updated with the tag-sets and tags you defined in the tag-set dialog, described above.
This will work in any Mastodon views, BDV or \TrackScheme.

\TrackScheme ships a second way to set tags quickly from the keyboard.
After selecting the spots and links of interest, press the \keys{Y} key.
A floating menu should appear on the left part of the view panel. 
Select the desired tag-set with the \keys{1}, \keys{2}, .. keys.
The menu now shows the tags defined within this tag-set, that you can select the same way.
Note that there is a way to remove all the tags over all the tag-sets on the selection by pressing \keys{\shift+\del} on the first menu, or just the tags of the selected tag-set by pressing \keys{0} on the second menu.



\subsubsection{Coloring views by tag-sets.}

The tags we just defined and assigned can be used in with the views, to highlight the items that are tagged. 
In the \menu{View > Coloring} menu of any view in Mastodon, you will find a sub-menu updated with the tag-sets you created among other choices. 
By default, newly created views are colored with the \menu{None} coloring mode, which simply colors all the spots and links the same way, taking colors from render settings. 
If you select a mode corresponding to a tag-set, tagged spots and links will appear painted with the color you chose for the tags of this tag-sets.
This is very handy to mark some locations in the image or highlight interesting tracks in the data.
Later we will see that tags can be used to retrieve specific items for further processing.
Finally, in \TrackScheme there is an option to show a legend of the current coloring mode.
You can toggle it on or off and set the location of this legend in the \menu{View > Colorbar} menu.




\subsection{Numerical features.}

Numerical features are values that are calculated from the data.
For instance the mean intensity within a spot, or the displacement along a link.
They are very generic: thr main restrictions is that there must be a data item (a spot or a link) per feature value. 
But the feature itself can be scalar, non-scalar, real, integer, a string, a vector, 
\etc.
They are \textit{labile}. 
Because they are defined for a data item, they will become invalid as soon as the data item changes.
Think of what happens to the spot mean intensity if the spot is moved over the image for instance.
Because we want to accommodate extensibility and large data, we have to use a special system that we describe below. 

\subsubsection{Feature computation.}

Numerical feature values are calculated by \textbf{feature computers}.
Feature computers are actually specialized Mastodon plugins, made so that it is easy for a 3rd party (you) to implement their own features in Mastodon.
We explain you to write your own feature computer in the second part of this manual, dedicated to technical information.

Because feature computation can take very long on large images, you have to trigger it manually.
On Mastodon main window, you can find a button \texttt{compute features} button.
Pressing it will show the dialog below
TODO
Each feature computer is listed on the left panel.
By clicking on the name the right panel shows some information about the feature they compute. 

Note that they are named 'features' on this panel, but they are in reality the feature computers.
For instance if you click on the \texttt{Spot gaussian-filtered intensity}, you will see in the information panel that this computer generates a feature for the mean intensity (weighted by a gaussian) and its standard deviation within a spot.
Note also that they can have dependencies.
For instance, the \texttt{Link velocity} feature computer depends on the \texttt{Link displacement} feature to be present at the time of computation.

The check-box on the left of each feature computer name triggers whether they will be part of the next feature computation.
Press the \menu{\smallimg{bullet_green.png}Compute} button to trigger computation of features.
You will probably notice, thanks to the progress bar, that the intensity-related features are the ones that take the most time to compute. 

Once the computation of all the features is complete, all the small clock icons that were shown right to the feature computer names now turned to a green dot\smallimg{bullet_green.png}.
This is how we keep track of the validity of the feature values.
Since the feature computation is triggered manually, and that a feature value might invalidated if the data changes (new spots added, removed, moved, changed the radius, added or removed some links), this icon serves as a signal for feature value de-synchronization.     
If the icon is shows as a clock~\smallimg{time.png}, it means that the data changed since the last feature computation, and that the feature values are out of sync. 
If is shows a green dot\smallimg{bullet_green.png}, then the data did not change since last computation, and the feature values are sure to be valid. 
This is very important for proper interpretation of the data, and you will have to show the computation dialog often just to check the feature values validity. 
By the way, you can check now how the validity flag works. 
While keeping the feature computation dialog open, move a spot in a BDV view. 
You should see that all the green dot icons now turn to the clock icon.
Also, if you now deselect some feature computers before launching a new computation, the validity flag will not turn to the green dot icon for those feature computers.

I guess that since we have feature values computed, you would like to inspect them and export them for further analysis.
This is the role of the table view, but before getting to it, we will make a little detour to showing how to use features to generate coloring, accelerating updates of computation and saving them to disk.


\subsubsection{Coloring views by numerical features.}

We have seen above that tag-sets could be used to generate coloring of the data items shown in a view. 
Indeed, in the \menu{View > Coloring} menu of each view, that tag-sets are listed and when selected, are used to assign a color to each data item.
We can do something similar with feature values, except that feature based coloring requires more input from us.

Feature color modes need to be created first, and this is done in a dedicated user interface. 
Select the \menu{File > Preferences} menu item in the main window or any view.
The preferences dialog is shown.
It is organized with a side-bar on the left that contains the various items that can be configured in Mastodon. 
Parenthetically, you can see that you can configure the display style of the ]+\TrackScheme and BDV views, and the keymaps. 
But we will see this later.
In the sidebar select \texttt{Feature Color Modes}.
The panel on the right now display the feature color mode configuration panel.

Its top line has a drop-down list that contains all the color modes already defined. 
Right now, there is only one, called \texttt{Number of links}.
As the \texttt{\textit{built-in}} suffix indicates, it is a built-in color modes, and it cannot be edited. 
To create a new one you must duplicate it and rename the new one.   
Do so by clicking on the \texttt{Duplicate} button, then on \texttt{Rename}.
Let's create a color mode that color spots and links based on the mean intensity inside the spots, that we would call \texttt{Mean intensity}.

The rest of the configuration panel is made of two parts.
The top part configures the vertex coloring, or how we color spots.
The bottom part configures the edge coloring, or how we color links. 
In Mastodon the data is organized in a mathematical graph, in which the vertices are the spots, and the edges are the links that connect spots from one frame to another, so you will sometimes find in Mastodon and in this manual the vocables vertex and edge to design a spot and a link respectively. 
The vertex color mode specifies where do we take colors from. 
You can choose between:
\begin{myitemize}
    \item \texttt{Vertex}, which means a spot will take its color from a feature value it owns.
    \item \texttt{Incoming edge}, which means a spot will take its color from a feature value owned by the single incoming link that targets this spot. This is the link backward in time. If there are no such links or more than one, then the default color is used.
    \item \texttt{Outgoing edge} is the same thing, but for the link forward in time. 
    \item \texttt{Default} mode does not rely on feature values but simply uses the default color in the view.
\end{myitemize}

\noindent Depending on the mode you chose, the content of the drop-down list below, called \texttt{Vertex feature}, will change to reflect either the list of spot features or the link features.
Select \texttt{Vertex} as a color mode and \texttt{Spot gaussian-filtered intensity} as feature.
Two new drop-down list appear on the right of the feature list. 
One contains the list of projections in the feature and the second one contains the list of channels in the dataset. 

We need to explain a bit what are \textbf{feature projections}.
We said above that a feature could be roughly anything numerical, and was not necessarily a scalar. 
It could be a vector, a tensor, a complex number, \etc.
However to be usable and useful in Mastodon, features are required to expose a sensible list of projections that compose them.
Feature projections are scalar and real values that can decompose or project a feature on a real axis.
How they are defined is up to the person that created the feature computer, but we can rely on the \textit{hope} that they choose wisely. 
For instance, a feature that gives the velocity vector of a link will reasonably expose 3 projections, one for each of the X, Y and Z component of the vector. 
Or maybe the polar angle, azimuthal angle and norm of this vector.
Or maybe the 6 projections since they can be calculated on the fly. 
A complex feature value will reasonably expose 2 projections, one for the real part, one of the imaginary part.
\textit{Etc}.
The \texttt{Spot gaussian-filtered intensity} feature has two projections, one for the mean value of the intensity within a spot and the standard deviation of this intensity.
Since both can be computed on any of the channel present in the dataset, their number is multiplied by the number of channels. 
The configuration panel changes according to the number of projections in a feature and its multiplicity. 
For features that are made of one real value with no multiplicity, the projection list is superfluous and not shown.
In our case, we simply want the mean of the only channel in the dataset.

Coming back to the color mode configuration, next we need to pick a color-map.
A color-map acts as the LUT for an image, and maps a color to a certain value. 
Mastodon ships about 20 of them, many taken from the MatPlotLib project\footnote{\url{https://matplotlib.org/3.1.1/gallery/color/colormap_reference.html}}.
Finally, you have to specify a min value and a max value that will act as the brightness and contrast values for an image.
Values below the min you defined will all be displayed with the first color of the color-map and values larger than the max with last.
The black square you see next to the graded representation of the color-map is the color used for data items for which the feature value is not present or undefined (division by zero, \etc).
The \texttt{autoscale} button computes the min and max automatically from the feature currently selected with the values taken from the last feature computation.

The edge coloring works exactly the same, except for the edge color mode.
\begin{myitemize}
    \item \texttt{Edge} means that a link will be colored by a feature value it owns.
    \item \texttt{Source vertex} will take a feature value from the source spot of this link, that is, the first in time.
    \item \texttt{Target vertex} does the same but for the last spot in time of this link. 
    \item \texttt{Default} mode does not rely on feature values but simply uses the default color in the view.
\end{myitemize}
\noindent To build our example feature color mode, choose \texttt{Source vertex} as color mode, and use for instance the \texttt{viridis} color-map along with 0 and 1200 for min and max values.
Do the same for the vertex color mode.

















\subsubsection{Accelerating feature computation with the update mechanism.}


\subsection{Tags, numerical features and saving the data to disk.}

\subsection{The data table views.}

